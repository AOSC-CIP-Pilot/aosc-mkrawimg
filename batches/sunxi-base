#! /bin/bash

rm -f out/* aux_log/*

sunxi_devices_list="
sun4i-a10-cubieboard
sun7i-a20-cubietruck
sun7i-a20-bananapi-m1-plus

sun8i-h2-plus-orangepi-zero
sun8i-h3-orangepi-one
sun8i-h3-orangepi-plus
sun8i-h3-nanopi-neo
sun8i-h3-bananapi-m2-plus
"

sunxi_devices_list_emmc_mmc2="
sun8i-h3-orangepi-plus
sun8i-h3-bananapi-m2-plus
"

export SOLUTION=sunxi-base
# STUB_TARBALL environment variable is needed
rm -rf cielfs *.tar.xz
ciel init "$STUB_TARBALL"
# Workaround
mkdir -p cielfs/50-override/etc/systemd/
cat > cielfs/50-override/etc/systemd/resolved.conf << EOF
[Resolve]
DNS=114.114.114.114
DNSSEC=no
EOF
for i in $sunxi_devices_list
do
	DEVICE_NAME=$i ciel generate sunxi-base
	ciel release sunxi_base_$i 1
	mv *.tar.xz temp.tar.xz
	TARBALL=$PWD/temp.tar.xz DEVICE_NAME=$i ./raw-image-builder
	rm temp.tar.xz
	for j in out/*.img # Uncompressed ones
	do
		xz $XZFLAGS $j
		for k in md5 sha1 sha512
		do
			${k}sum $j.xz | awk '{print $1}' > $j.xz.${k}sum
		done
	done
done

#for i in $sunxi_devices_list_emmc_mmc2
#do
#	DEVICE_NAME=$i MMC=2 ./raw-image-builder
#	for j in out/*.img # Uncompressed ones
#	do
#		xz $XZFLAGS $j
#		for k in md5 sha1 sha512
#		do
#			${k}sum $j.xz | awk '{print $1}' > $j.xz.${k}sum
#		done
#	done
#done
